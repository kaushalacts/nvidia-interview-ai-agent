# =========================
# BUILDER
# =========================
FROM python:3.11-slim AS builder

WORKDIR /build

RUN apt-get update && apt-get install -y build-essential \
 && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir --prefer-binary -r requirements.txt


# =========================
# RUNTIME (DISTROLESS)
# =========================
FROM gcr.io/distroless/python3-debian12

WORKDIR /app

# ---- Python deps ----
COPY --from=builder \
  /usr/local/lib/python3.11/site-packages \
  /usr/local/lib/python3.11/site-packages

# ---- App code (owned by nonroot) ----
COPY --chown=nonroot:nonroot api ./api
COPY --chown=nonroot:nonroot agents ./agents
COPY --chown=nonroot:nonroot rag ./rag

# âœ… Create writable SQLite directory WITHOUT RUN
COPY --chown=nonroot:nonroot --from=builder /tmp /data

# ---- Python path ----
ENV PYTHONPATH=/app:/usr/local/lib/python3.11/site-packages

USER nonroot
EXPOSE 8000

CMD ["-m", "uvicorn", "api.main:app", "--host=0.0.0.0", "--port=8000"]

